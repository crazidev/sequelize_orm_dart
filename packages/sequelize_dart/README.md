# sequelize_dart

Main ORM package for Sequelize.js integration in Dart. Provides database connectivity, query building, and model management for PostgreSQL, MySQL, and MariaDB.

## Overview

Sequelize Dart uses a **unified Node.js bridge** architecture that works seamlessly on both Dart VM (server-side) and dart2js (compiled JavaScript). The bridge handles all Sequelize.js operations, ensuring consistent behavior across platforms.

## Architecture

### Bridge Communication

- **Dart VM**: Communicates with bridge via stdin/stdout (child process)
- **dart2js**: Communicates with bridge via postMessage (Worker Thread)
- **Protocol**: JSON-RPC for all operations
- **Bridge**: Single bundled JavaScript file (`bridge_server.bundle.js`)

### Package Structure

- **`src/sequelize/`** - Main Sequelize instance and initialization
- **`src/model/`** - Model base classes and instance management
- **`src/query/`** - Query builders and operators
- **`src/bridge/`** - Bridge client implementations (Dart VM and dart2js)
- **`src/connection/`** - Database connection and dialect support
- **`src/utils/`** - Utilities (SQL formatting, attribute conversion)

## Core Components

### Sequelize Instance

The main entry point for database connections:

```dart
final sequelize = Sequelize().createInstance(
  PostgressConnection(
    url: 'postgresql://user:pass@localhost:5432/dbname',
  ),
);

await sequelize.initialize(
  models: [User.instance, Post.instance],
);
```

### Models

Models are defined using annotations and generated by `sequelize_dart_generator`:

```dart
@Table(tableName: 'users')
class User {
  @PrimaryKey()
  @AutoIncrement()
  DataType id = DataType.INTEGER;

  static $User get instance => $User();
}
```

The generator creates a `$User` class with all CRUD operations and type-safe query builders.

### Query Builders

Type-safe query building using column accessors:

```dart
// Type-safe where clauses
final users = await User.instance.findAll(
  where: (user) => user.email.equals('user@example.com'),
  order: [['id', 'DESC']],
  limit: 10,
);
```

### Operators

Query operators are provided as extensions on `Column<T>`:

- **Comparison**: `eq`, `ne`, `gt`, `gte`, `lt`, `lte`
- **String**: `like`, `iLike`, `notLike`
- **Null**: `isNull`, `isNotNull`
- **List**: `in_`, `notIn`
- **Logical**: `and`, `or`, `not`

## Connection Dialects

### PostgreSQL

```dart
final sequelize = Sequelize().createInstance(
  PostgressConnection(
    url: 'postgresql://user:pass@localhost:5432/dbname',
    schema: 'public',
    ssl: false,
  ),
);
```

### MySQL

```dart
final sequelize = Sequelize().createInstance(
  MysqlConnection(
    url: 'mysql://user:pass@localhost:3306/dbname',
  ),
);
```

### MariaDB

```dart
final sequelize = Sequelize().createInstance(
  MariadbConnection(
    url: 'mariadb://user:pass@localhost:3306/dbname',
  ),
);
```

## Query Execution Flow

1. **Query Builder** - Build query using type-safe operators
2. **Query Engine** - Convert Dart query to Sequelize.js format
3. **Bridge Client** - Send JSON-RPC request to bridge
4. **Bridge Server** - Execute query in Node.js with Sequelize.js
5. **Response** - Results streamed back to Dart
6. **Deserialization** - Convert JSON to Dart model instances

## Model Lifecycle

1. **Define** - Annotate model class
2. **Generate** - Run `build_runner` to generate `$ClassName` implementation
3. **Register** - Add to `sequelize.initialize(models: [...])`
4. **Query** - Use generated methods for CRUD operations

## Type Safety

The package provides full type safety through:

- **Generated Classes** - Type-safe model implementations
- **Query Builders** - Compile-time checked column accessors
- **Create Helpers** - Named parameter classes (`$UserCreate`)
- **Column Types** - Generic `Column<T>` for type inference

## Platform Support

### Dart VM (Server)

- Bridge runs as child process
- Communication via stdin/stdout
- Full access to file system and Node.js

### dart2js (Compiled JavaScript)

- Bridge runs in Worker Thread
- Communication via postMessage
- Requires preamble for Node.js compatibility

## Error Handling

Errors are wrapped in Dart exceptions:

- `BridgeException` - Bridge communication errors
- `SequelizeException` - Sequelize.js operation errors
- Database-specific errors preserved in exception messages

## Utilities

### SQL Formatter

Pretty-print SQL queries for debugging:

```dart
SqlFormatter.printFormatted(sql);
```

### Attribute Converter

Convert between Dart and Sequelize.js data formats automatically.

## See Also

- [sequelize_dart_annotations](../sequelize_dart_annotations/README.md) - Annotations package
- [sequelize_dart_generator](../sequelize_dart_generator/README.md) - Code generator
