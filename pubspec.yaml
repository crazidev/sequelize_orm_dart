name: _
environment:
  sdk: ^3.6.0

workspace:
  - packages/sequelize_orm
  - packages/sequelize_orm_generator
  - example
  - packages/sequelize_orm_analyzer

dev_dependencies:
  melos: ^7.4.0
  test: ^1.28.0

melos:
  sdkPath: auto
  repository: https://github.com/crazidev/sequelize_orm_dart

  categories:
    packages:
      - packages/**
    examples:
      - example

  command:
    version:
      branch: main
      message: "chore(release): publish packages\n\n{new_package_versions}"
      linkToCommits: true
      workspaceChangelog: true

    publish:
      packageFilters:
        category: packages

  scripts:
    # ─── Analysis & Linting ─────────────────────────────
    analyze:
      description: Run dart analyze across all packages.
      run: dart analyze --fatal-infos
      exec:
        concurrency: 1

    fix:
      description: Apply dart fix across all packages.
      run: dart fix --apply
      exec:
        concurrency: 1

    # ─── Testing ────────────────────────────────────────
    test:
      description: Run tests across all packages.
      run: dart test
      exec:
        concurrency: 1
        failFast: true
      packageFilters:
        dirExists: test

    # ─── Code Generation ───────────────────────────────
    generate:
      description: Run build_runner for code generation.
      run: dart run build_runner build --delete-conflicting-outputs
      exec:
        concurrency: 1
        orderDependents: true
      packageFilters:
        dependsOn: build_runner

    generate:watch:
      description: Watch and regenerate code on changes.
      run: dart run build_runner watch --delete-conflicting-outputs
      exec:
        concurrency: 1
      packageFilters:
        dependsOn: build_runner

    generate:models:
      description: Generate models from database.
      run: dart run sequelize_orm_generator:generate --generate
      exec:
        concurrency: 1
      packageFilters:
        category: examples

    generate:seed:
      description: Generate seeders from database.
      run: dart run sequelize_orm_generator:generate --seed
      exec:
        concurrency: 1
      packageFilters:
        category: examples

    # ─── Release & Publishing ─────────────────────────────
    release:dry:
      description: Dry-run release (merge dev to main, verify publish).
      run: dart run tools/release_publish.dart

    release:publish:
      description: Merge dev to main and publish packages to pub.dev.
      run: dart run tools/release_publish.dart --publish

    release:publish:tag:
      description: Publish, create git tags and GitHub releases per package.
      run: dart run tools/release_publish.dart --publish --tag --github-release
