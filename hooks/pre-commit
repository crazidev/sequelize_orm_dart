#!/bin/bash

# Pre-commit hook to format code before committing
# This ensures all code is properly formatted before it enters the repository

# Get the git root directory
# Hooks run from .git/hooks/, so we need to go up two levels to get to the repo root
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [[ "$HOOK_DIR" == *"/.git/hooks" ]]; then
  # Hook is in .git/hooks, go up two levels to repo root
  ROOT_DIR="$(cd "$HOOK_DIR/../.." && pwd)"
elif [ -d "$HOOK_DIR/../.." ] && [ -d "$(cd "$HOOK_DIR/../.." && pwd)/.git" ]; then
  # Try going up two levels
  ROOT_DIR="$(cd "$HOOK_DIR/../.." && pwd)"
else
  # Fallback: use git rev-parse if we're in a work tree
  ROOT_DIR="$(cd "$HOOK_DIR/../.." && git rev-parse --show-toplevel 2>/dev/null || pwd)"
fi

# Change to root directory
if [ -n "$ROOT_DIR" ] && [ -d "$ROOT_DIR" ]; then
  cd "$ROOT_DIR" || exit 1
else
  echo "Error: Could not find git repository root from $HOOK_DIR"
  exit 1
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîß Running pre-commit formatting...${NC}\n"

# Run the format script
if [ -f "tools/format.sh" ]; then
  bash tools/format.sh
  
  # Stage the formatted files
  git add -u
  
  echo -e "\n${GREEN}‚úÖ Pre-commit formatting complete!${NC}"
else
  echo -e "${RED}‚ùå Format script not found at tools/format.sh${NC}"
  exit 1
fi

